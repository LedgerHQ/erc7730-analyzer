name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          version: "0.6.14"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --dev

      - name: Ruff lint
        run: uv run ruff check src/

      - name: Ruff format check
        run: uv run ruff format --check src/

  commitlint:
    name: Commit Messages
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          echo "Checking commit messages for semantic format..."
          echo ""

          # Allowed emoji prefixes
          PATTERN='^(ğŸ‰ init|âœ¨ feat|ğŸ› fix|ğŸ“ docs|ğŸ’„ style|â™»ï¸ refactor|âœ… test|ğŸ‘· ci|â¬†ï¸ deps|ğŸ³ docker|ğŸ”§ chore|ğŸ¤– chore|ğŸ”¥ chore|ğŸ”€ merge):'

          FAILED=0
          while IFS= read -r msg; do
            if ! echo "$msg" | grep -qP "$PATTERN"; then
              echo "âŒ Invalid: $msg"
              FAILED=1
            else
              echo "âœ… Valid:   $msg"
            fi
          done < <(git log --format='%s' origin/${{ github.base_ref }}..${{ github.event.pull_request.head.sha }})

          echo ""
          if [ "$FAILED" -eq 1 ]; then
            echo "::error::Commit messages must follow semantic format: <emoji> <type>: <description>"
            echo ""
            echo "Allowed formats:"
            echo "  âœ¨ feat: add new feature"
            echo "  ğŸ› fix: fix a bug"
            echo "  ğŸ“ docs: update documentation"
            echo "  ğŸ’„ style: formatting changes"
            echo "  â™»ï¸ refactor: code restructuring"
            echo "  âœ… test: add or update tests"
            echo "  ğŸ‘· ci: CI/CD changes"
            echo "  â¬†ï¸ deps: dependency updates"
            echo "  ğŸ³ docker: Docker changes"
            echo "  ğŸ”§ chore: maintenance tasks"
            echo "  ğŸ”€ merge: merge commits"
            exit 1
          fi

          echo "All commit messages follow semantic format âœ…"
