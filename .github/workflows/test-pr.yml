name: Analyze ERC-7730 Files on PR

on:
  pull_request:
    paths:
      - '**/calldata-*.json'

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Get changed calldata files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            **/calldata-*.json

      - name: Run analyzer on each file
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Analyzing: $file"
            python analyze_7730.py --erc7730_file "$file" --api-key "$ETHERSCAN_API_KEY" --lookback-days 20
          done

      - name: Commit reports to PR branch
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Move reports to Analysis directory
          mkdir -p Analysis
          cp output/*.md Analysis/ 2>/dev/null || echo "No .md files to copy"

          # Commit if there are changes
          git add Analysis/
          if git diff --staged --quiet; then
            echo "No reports to commit"
          else
            git commit -m "chore: add analysis reports [skip ci]"
            git push
          fi

      - name: Upload analysis reports as artifacts
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: analysis-reports
          path: output/
          retention-days: 30

      - name: Post summary to PR
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const reportsDir = 'Analysis';
            if (!fs.existsSync(reportsDir)) {
              console.log('No reports directory found');
              return;
            }

            const files = fs.readdirSync(reportsDir).filter(f => f.endsWith('.md'));

            let body = '## ğŸ” ERC-7730 Analysis Complete\n\n';
            body += `ğŸ“Š **Reports generated:** ${files.length}\n\n`;
            body += '### ğŸ“„ View Full Reports:\n';

            const branch = context.payload.pull_request.head.ref;
            const repo = context.repo;

            for (const file of files) {
              const fileUrl = `https://github.com/${repo.owner}/${repo.repo}/blob/${branch}/Analysis/${file}`;
              body += `- [${file}](${fileUrl})\n`;
            }

            body += '\nğŸ’¾ Reports have been committed to the `Analysis/` directory in this PR.\n';
            body += '\nğŸ“¥ You can also download them from the workflow artifacts below.';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
